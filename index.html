<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ROC/PR 曲线分析工具 · 增强版</title>
  <!-- 依赖 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <!-- 样式文件 -->
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <div class="title">
          <img src="assets/images/logo.png" alt="Logo" class="logo" />
          ROC/PR 曲线分析工具 <span class="tag">增强版</span>
        </div>
        <div class="muted">支持 Excel/CSV、列映射、最优阈值、阈值滑块、混淆矩阵、导出曲线点、PR 曲线与 AP、可选 AUC CI。</div>
      </div>
      <div class="btn-group">
        <button id="btn-faq" class="btn ghost small">说明文档</button>
        <button id="btn-download-images" class="btn ghost small">下载图片</button>
        <button id="btn-download-template" class="btn ghost small">下载模板</button>
        <button id="btn-clear" class="btn ghost small">清空数据</button>
      </div>
    </div>

    <!-- 说明文档模态框 -->
    <div id="faq-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:999;">
      <div style="max-width:760px; margin:50px auto; background:#121a2b; border-radius:12px; padding:20px; color:#fff; overflow:auto; max-height:80%;">
        <h2>说明文档 / FAQ</h2>
        <p><strong>ROC 曲线</strong>：横轴是假阳性率（1-特异性），纵轴是真阳性率（灵敏度）。AUC 反映整体分类性能。</p>
        <p><strong>PR 曲线</strong>：横轴是召回率（Recall），纵轴是精确率（Precision）。AP 为曲线下面积。</p>
        <p><strong>灵敏度</strong>：TP/(TP+FN)。<strong>特异性</strong>：TN/(TN+FP)。<strong>Youden 指数</strong>：敏感度+特异性-1。</p>
        <p><strong>混淆矩阵</strong>：TP/FP/FN/TN 的统计；<strong>自助法</strong>：重复采样估计 AUC 的 95% CI。</p>
        <hr>
        <h3>病原体检测场景</h3>
        <p><strong>RPM</strong>：mNGS/tNGS 中病原目标在总读段的相对丰度；阈值低→↑灵敏度/↓特异性；阈值高→↑特异性/↓灵敏度。</p>
        <ul>
          <li><em>结核分枝杆菌</em>：用 ROC 寻找 RPM 阈值，兼顾漏检与误报。</li>
          <li>多病原呼吸道场景：阳性基数低，PR 曲线与 AP 更具参考价值。</li>
          <li>血流感染：AUC 越高，越能区分感染/非感染。</li>
        </ul>
        <h3>图文示例</h3>
        <img src="https://raw.githubusercontent.com/plotly/datasets/master/images/roc_demo.png" alt="ROC 示例" class="faq-img" />
        <p>阈值低：几乎判阳（敏感度高/特异性低）；阈值高：判别严格（特异性高/敏感度低）。</p>
        <div style="text-align:right"><button id="faq-close" class="btn small">关闭</button></div>
      </div>
    </div>

    <div class="grid">
      <!-- 左侧：数据与设置 -->
      <div class="card">
        <div class="hd"><h3>1) 数据上传与列映射</h3><span class="pill">Excel（.xlsx/.xls）或 CSV</span></div>
        <div class="bd">
          <input id="file" class="file" type="file" accept=".xlsx,.xls,.csv" />
          <div class="sep"></div>
          <div class="row">
            <div style="flex:1"><label>样本标识列</label><select id="col-id"></select></div>
            <div style="flex:1"><label>金标准列（阳性/阴性 或 1/0）</label><select id="col-label"></select></div>
            <div style="flex:1"><label>评分列（RPM）</label><select id="col-score"></select></div>
          </div>
          <div class="sep"></div>
          <div class="row">
            <button id="btn-parse" class="btn primary">解析并绘图</button>
            <button id="btn-export-roc" class="btn">导出 ROC 点</button>
            <button id="btn-export-pr" class="btn">导出 PR 点</button>
          </div>
          <div class="sep"></div>
          <div class="table-wrap"><table id="preview"><thead></thead><tbody></tbody></table></div>
        </div>
      </div>

      <!-- 右侧：阈值与优化 -->
      <div class="card">
        <div class="hd"><h3>2) 阈值与优化</h3><span class="pill">Youden / 距(0,1)最近 / 权重</span></div>
        <div class="bd">
          <div class="kpi">
            <div class="item"><div class="label">AUC</div><div id="kpi-auc" class="val">—</div></div>
            <div class="item"><div class="label">AP（PR 面积）</div><div id="kpi-ap" class="val">—</div></div>
            <div class="item"><div class="label">阳性数(P)</div><div id="kpi-p" class="val">—</div></div>
            <div class="item"><div class="label">阴性数(N)</div><div id="kpi-n" class="val">—</div></div>
          </div>

          <div class="sep"></div>
          <div class="row">
            <button id="btn-opt-youden" class="btn success">最优阈值（Youden）</button>
            <button id="btn-opt-closest" class="btn">最优阈值（距 0,1 最近）</button>
            <button id="btn-opt-sens" class="btn">灵敏度优先</button>
            <button id="btn-opt-spec" class="btn">特异性优先</button>
          </div>

          <div class="sep"></div>
          <div class="row">
            <div style="flex:1">
              <label>自定义权重：α·敏感度 + β·特异性 最大化</label>
              <div class="row">
                <input id="w-sens" type="number" step="0.1" value="1" />
                <input id="w-spec" type="number" step="0.1" value="1" />
                <button id="btn-opt-weight" class="btn small">按权重优化</button>
              </div>
            </div>
          </div>

          <div class="sep"></div>
          <label>阈值滑块（基于评分/RPM）</label>
          <input id="th-slider" type="range" min="0" max="100" step="1" value="0" />
          <div class="row"><input id="th-value" type="number" placeholder="输入阈值" /><button id="btn-apply-th" class="btn small">应用阈值</button></div>

          <div class="kpi" style="margin-top:12px">
            <div class="item"><div class="label">敏感度</div><div id="kpi-sens" class="val">—</div></div>
            <div class="item"><div class="label">特异性</div><div id="kpi-spec" class="val">—</div></div>
            <div class="item"><div class="label">准确率</div><div id="kpi-acc" class="val">—</div></div>
            <div class="item"><div class="label">F1</div><div id="kpi-f1" class="val">—</div></div>
          </div>

          <div class="sep"></div>
          <div class="cmatrix">
            <div class="c"><div class="label">TP</div><div id="cm-tp" class="big">—</div></div>
            <div class="c"><div class="label">FP</div><div id="cm-fp" class="big">—</div></div>
            <div class="c"><div class="label">FN</div><div id="cm-fn" class="big">—</div></div>
            <div class="c"><div class="label">TN</div><div id="cm-tn" class="big">—</div></div>
          </div>

          <div class="sep"></div>
          <div class="row">
            <label><input type="checkbox" id="chk-ci" /> 估计 AUC 95% CI（自助法 B=200）</label>
            <button id="btn-ci" class="btn small">计算 CI</button>
            <div id="ci-out" class="note"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <div class="hd"><h3>3) 可视化</h3><span class="pill">点击图例可开关曲线</span></div>
      <div class="bd">
        <div class="grid-plot">
          <div><div id="roc" style="height:420px"></div></div>
          <div><div id="pr" style="height:420px"></div></div>
        </div>
        <div class="row" style="margin-top:12px">
          <button id="btn-save-png" class="btn">保存 PNG</button>
          <button id="btn-save-svg" class="btn">保存 SVG</button>
        </div>
      </div>
    </div>

    <div class="footer">© ROC/PR 曲线分析工具 · 单文件版 · 本地离线可用</div>
  </div>

  <!-- JavaScript文件 -->
  <script src="js/script.js"></script>
</body>
</html>